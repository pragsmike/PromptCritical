# `pcrit.pdb` API Reference

The `pcrit.pdb` namespace provides a complete library for interacting with a file-based database of LLM prompts. It handles all file I/O, data serialization, and concurrency management, presenting a simple and robust API to the user.

## The Prompt Record

All functions in this API operate on a consistent data structure called a **Prompt Record**. This is a Clojure map with two keys:

*   `:header`: A map containing all metadata for the prompt.
*   `:body`: A string containing the prompt's text in its canonical form.

```clojure
{:header {:id "P1", :created-at "...", :sha1-hash "...", ...}
 :body   "The canonical text of the prompt.\n"}
```

## Core Concepts

### Canonical Text Representation

To ensure data integrity and consistent hashing, all prompt bodies are stored and returned in a canonical format. User-provided text is automatically converted upon creation. The canonicalization rules are as follows:

1.  The text is normalized to Unicode NFC (Canonical Composition).
2.  All line endings (CRLF `\r\n` and CR `\r`) are converted to Line Feeds (LF `\n`).
3.  The text is guaranteed to end with exactly one trailing `\n`.

### Timestamps

All timestamps generated by the system (such as `:created-at`) are strings formatted according to the **ISO-8601** standard and are always in the UTC timezone, indicated by the `Z` suffix (e.g., `"2025-06-29T21:45:10Z"`).

### Immutability

The prompt `:body` is immutable. Once a prompt is created, its text can never be changed. The API enforces this; only metadata in the `:header` can be updated.

---

## API Functions

### `create-prompt`

```clojure
(create-prompt db-dir prompt-text & {:keys [metadata]})
```

Creates a new prompt in the database, writes it to a file, and returns its complete prompt record.

**Arguments:**

*   `db-dir`: (String) The path to the directory containing the prompt database.
*   `prompt-text`: (String) The raw text of the prompt to be created.
*   `metadata`: (Optional Map) A map of any additional metadata to be included in the header.

**Return Value:**

On success, returns a **prompt record map** representing the newly created prompt.

*   The `:body` of the returned record is the **canonicalized** version of the `prompt-text` that was passed in.
*   The `:header` of the returned record will contain the following system-generated fields, merged with any user-provided `metadata`:
    *   `:id`: A new, unique string ID (e.g., `"P1"`).
    *   `:created-at`: An ISO-8601 timestamp string.
    *   `:sha1-hash`: The SHA-1 hash of the canonical body.
    *   `:spec-version`: The specification version, currently `"1"`.

**Side Effects:**

*   Creates a new file named `[id].prompt` in the `db-dir`.
*   Atomically updates a counter file within the `db-dir` to generate the next ID.

### `read-prompt`

```clojure
(read-prompt db-dir id)
```

Reads a specific prompt from the database by its ID.

**Arguments:**

*   `db-dir`: (String) The path to the prompt database directory.
*   `id`: (String) The ID of the prompt to read (e.g., `"P1"`).

**Return Value:**

*   If the prompt exists, returns the corresponding **prompt record map**.
*   If the prompt file does not exist, returns `nil`.

**Notes:**

*   Upon every read, this function calculates the SHA-1 hash of the body and compares it against the `:sha1-hash` stored in the header. If they do not match, a warning is logged, signaling potential data corruption.

### `update-metadata`

```clojure
(update-metadata db-dir id f)
```

Atomically updates the metadata header of an existing prompt. The prompt body is guaranteed to be unchanged.

**Arguments:**

*   `db-dir`: (String) The path to the prompt database directory.
*   `id`: (String) The ID of the prompt to update.
*   `f`: (Function) A function that will be called with the old header map. It must return a new map representing the desired header.

**Return Value:**

On success, returns the updated **prompt record map**, containing the new header and the original, unchanged body.

**Side Effects:**

*   Atomically rewrites the prompt file with the updated header.

**Failure Conditions:**

This function will throw a `clojure.lang.ExceptionInfo` if:
*   The prompt with the specified `id` does not exist.
*   A lock for the prompt file cannot be acquired (indicating it is being modified by another process).
*   The update function `f` attempts to change the `:id` or `:sha1-hash` fields, which is not allowed.
